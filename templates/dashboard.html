<!DOCTYPE html>
<html>
  <head>
    <title>Watch Tracker Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    <style>
      .node {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: inline-block;
        margin: 20px;
        text-align: center;
        line-height: 100px;
        font-size: 14px;
        font-weight: bold;
        position: relative;
      }
      .node .device-count {
        position: absolute;
        top: -10px;
        right: -10px;
        background-color: #fff;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        line-height: 30px;
        font-size: 12px;
      }
      .lora {
        background-color: rgba(75, 192, 192, 0.6);
      }
      .ble {
        background-color: rgba(255, 99, 132, 0.6);
      }
    </style>
  </head>
  <body>
    <h1>Watch Tracker Dashboard</h1>
    <div id="map"></div>

    <script>
      const socket = io();
      const map = document.getElementById("map");

      {% for mac_address, node_data in watch_nodes.items() %}
        const node = document.createElement("div");
        node.classList.add("node");
        node.classList.add("{{ node_data.type.lower() }}");
        node.setAttribute("data-mac", "{{ mac_address }}");
        node.textContent = "{{ mac_address }}";
        map.appendChild(node);

        const deviceCount = document.createElement("div");
        deviceCount.classList.add("device-count");
        deviceCount.textContent = "{{ node_devices.get(node_data.node_mac, [])|length }}";
        node.appendChild(deviceCount);
      {% endfor %}

      socket.on("tag_update", function (data) {
        const nodeElement = document.querySelector(`[data-mac="${data.mac_address}"]`);
        if (nodeElement) {
          nodeElement.setAttribute("data-node-type", data.node_type.toLowerCase());
          nodeElement.classList.remove("lora", "ble");
          nodeElement.classList.add(data.node_type.toLowerCase());
        } else {
          const node = document.createElement("div");
          node.classList.add("node");
          node.classList.add(data.node_type.toLowerCase());
          node.setAttribute("data-mac", data.mac_address);
          node.setAttribute("data-node-type", data.node_type.toLowerCase());
          node.textContent = data.mac_address;
          map.appendChild(node);

          const deviceCount = document.createElement("div");
          deviceCount.classList.add("device-count");
          deviceCount.textContent = "0";
          node.appendChild(deviceCount);
        }
      });

      // Debounce function
      function debounce(func, wait) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      const debouncedDeviceCountUpdate = debounce(function(data) {
        const nodeElement = document.querySelector(`[data-mac="${data.node_mac}"]`);
        if (nodeElement) {
          const deviceCountElement = nodeElement.querySelector(".device-count");
          deviceCountElement.textContent = data.count;
        }
      }, 100); // Adjust the debounce time as needed

      socket.on("device_count_update", debouncedDeviceCountUpdate);
    </script>
  </body>
</html>
